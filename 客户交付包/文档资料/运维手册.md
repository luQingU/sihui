# 🛠️ Sihui 智慧学习平台运维手册

## 📋 概述

本手册为 Sihui 智慧学习平台的运维管理指南，包含日常监控、故障处理、性能优化、备份恢复等运维工作的标准流程。

## 🎯 运维目标

- **可用性**: ≥ 99.9%
- **响应时间**: ≤ 200ms
- **故障恢复**: ≤ 15分钟
- **数据安全**: 零丢失

## 📊 日常监控

### 系统监控指标

#### 服务器资源监控
- **CPU使用率**: 正常 < 70%，警告 > 80%，危险 > 90%
- **内存使用率**: 正常 < 75%，警告 > 85%，危险 > 95%
- **磁盘使用率**: 正常 < 80%，警告 > 90%，危险 > 95%
- **网络I/O**: 监控带宽使用情况
- **系统负载**: 1分钟负载 < 核心数

#### 应用服务监控
- **服务状态**: 所有服务必须处于 active 状态
- **端口监听**: 80, 443, 8080, 3000, 3306
- **API响应**: /actuator/health 返回 200
- **数据库连接**: 连接池状态正常

#### 业务指标监控
- **用户活跃度**: 在线用户数量
- **API调用量**: 每分钟请求数
- **错误率**: < 0.1%
- **数据库查询**: 慢查询监控

### 监控工具使用

#### 自动化监控脚本
```bash
# 运行系统监控
./自动化脚本/监控脚本.sh

# 定期执行（每5分钟）
echo "*/5 * * * * /opt/sihui/scripts/监控脚本.sh" | crontab -
```

#### 手动检查命令
```bash
# 检查服务状态
systemctl status sihui-backend sihui-frontend nginx mysql

# 检查资源使用
htop
free -h
df -h
iostat 1 5

# 检查网络
ss -tlnp
netstat -i

# 检查日志
journalctl -u sihui-backend -f --since "1 hour ago"
tail -f /var/log/nginx/access.log
```

## 🚨 故障处理

### 常见故障及解决方案

#### 1. 服务无法启动

**症状**: systemctl status 显示 failed 状态

**排查步骤**:
```bash
# 查看详细错误信息
journalctl -u sihui-backend -l

# 检查配置文件
cat /opt/sihui/backend/.env

# 检查端口占用
ss -tlnp | grep 8080

# 检查磁盘空间
df -h

# 检查内存
free -h
```

**解决方案**:
- 配置文件错误: 检查并修复配置
- 端口被占用: 终止占用进程或修改端口
- 磁盘空间不足: 清理日志和临时文件
- 内存不足: 重启服务或增加内存

#### 2. 数据库连接失败

**症状**: 应用无法连接数据库

**排查步骤**:
```bash
# 检查MySQL状态
systemctl status mysql

# 测试数据库连接
mysql -u sihui_user -p -h localhost

# 检查数据库配置
grep DB_ /opt/sihui/backend/.env

# 查看数据库日志
tail -f /var/log/mysql/error.log
```

**解决方案**:
- MySQL未启动: `systemctl start mysql`
- 用户权限问题: 重新授权用户
- 密码错误: 检查配置文件
- 连接数过多: 优化连接池配置

#### 3. 网站访问缓慢

**症状**: 页面加载时间过长

**排查步骤**:
```bash
# 检查系统负载
uptime
top

# 检查网络连接
ss -s
netstat -i

# 检查数据库性能
mysql -e "SHOW PROCESSLIST;"

# 检查慢查询
tail -f /var/log/mysql/mysql-slow.log
```

**解决方案**:
- CPU负载高: 优化代码或增加CPU
- 数据库慢查询: 优化SQL语句
- 网络拥塞: 检查网络配置
- 缓存未命中: 检查Redis配置

#### 4. SSL证书问题

**症状**: HTTPS访问失败

**排查步骤**:
```bash
# 检查证书文件
ls -la /opt/sihui/ssl/

# 测试证书有效期
openssl x509 -in /opt/sihui/ssl/*.crt -noout -dates

# 检查Nginx配置
nginx -t

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log
```

**解决方案**:
- 证书过期: 更新SSL证书
- 证书路径错误: 检查Nginx配置
- 证书权限问题: 修改文件权限

### 紧急故障处理流程

#### 严重故障处理（系统完全不可用）

1. **立即响应**（5分钟内）
   ```bash
   # 检查所有服务状态
   systemctl status sihui-backend sihui-frontend nginx mysql
   
   # 尝试重启失败的服务
   systemctl restart sihui-backend
   ```

2. **故障定位**（10分钟内）
   ```bash
   # 查看错误日志
   journalctl -u sihui-backend -l
   journalctl -u sihui-frontend -l
   
   # 检查系统资源
   df -h && free -h && uptime
   ```

3. **应急恢复**（15分钟内）
   ```bash
   # 如果单个服务问题，重启服务
   systemctl restart sihui-backend sihui-frontend
   
   # 如果是系统问题，重启服务器
   sudo reboot
   
   # 数据库问题时的应急措施
   systemctl restart mysql
   ```

4. **验证恢复**
   ```bash
   # 检查服务状态
   systemctl is-active sihui-backend sihui-frontend nginx mysql
   
   # 测试API接口
   curl https://api.your-domain.com/health
   
   # 测试前端访问
   curl -I https://admin.your-domain.com
   ```

## 🔧 维护操作

### 定期维护任务

#### 每日维护
- **系统监控**: 检查监控脚本输出
- **日志检查**: 查看错误日志
- **备份验证**: 确认自动备份成功
- **性能指标**: 检查关键性能指标

#### 每周维护
- **系统更新**: 安装安全补丁
- **日志清理**: 清理过期日志文件
- **性能分析**: 分析性能趋势
- **备份测试**: 测试备份恢复流程

#### 每月维护
- **安全检查**: 执行安全扫描
- **容量规划**: 评估资源使用趋势
- **配置优化**: 根据使用情况优化配置
- **文档更新**: 更新运维文档

### 系统更新流程

#### 应用更新
```bash
# 1. 创建备份
./自动化脚本/备份脚本.sh

# 2. 停止服务
systemctl stop sihui-backend sihui-frontend

# 3. 备份当前版本
cp /opt/sihui/backend/app.jar /opt/sihui/backup/app.jar.backup.$(date +%Y%m%d)

# 4. 部署新版本
cp new-version/app.jar /opt/sihui/backend/
cp -r new-version/frontend/.next /opt/sihui/frontend/

# 5. 更新数据库（如需要）
mysql -u sihui_user -p sihui_production < migration.sql

# 6. 启动服务
systemctl start sihui-backend sihui-frontend

# 7. 验证功能
curl https://api.your-domain.com/health
```

#### 系统更新
```bash
# Ubuntu/Debian
apt update && apt upgrade -y

# CentOS/RHEL
yum update -y

# 重启服务（如需要）
systemctl restart sihui-backend sihui-frontend nginx
```

### 配置管理

#### 配置文件位置
- 后端配置: `/opt/sihui/backend/.env`
- 前端配置: `/opt/sihui/frontend/.env.production`
- Nginx配置: `/etc/nginx/sites-available/sihui.conf`
- 系统服务: `/etc/systemd/system/sihui-*.service`

#### 配置更改流程
1. **备份原配置**
   ```bash
   cp /opt/sihui/backend/.env /opt/sihui/backup/.env.backup.$(date +%Y%m%d)
   ```

2. **修改配置**
   ```bash
   vi /opt/sihui/backend/.env
   ```

3. **验证配置**
   ```bash
   # 检查语法（如适用）
   nginx -t
   ```

4. **重启服务**
   ```bash
   systemctl restart sihui-backend
   ```

5. **验证功能**
   ```bash
   curl https://api.your-domain.com/health
   ```

## 💾 备份与恢复

### 备份策略

#### 自动备份配置
```bash
# 每日凌晨2点执行备份
echo "0 2 * * * /opt/sihui/scripts/备份脚本.sh" | crontab -

# 查看当前cron任务
crontab -l
```

#### 备份内容
- **数据库**: 完整数据备份
- **上传文件**: 用户上传的所有文件
- **配置文件**: 系统和应用配置
- **应用程序**: 当前运行的应用版本

#### 备份保留策略
- **每日备份**: 保留7天
- **每周备份**: 保留4周
- **每月备份**: 保留12个月
- **年度备份**: 长期保存

### 恢复流程

#### 数据库恢复
```bash
# 停止应用服务
systemctl stop sihui-backend

# 恢复数据库
mysql -u sihui_user -p sihui_production < backup_file.sql

# 启动应用服务
systemctl start sihui-backend
```

#### 文件恢复
```bash
# 恢复上传文件
tar -xzf uploads_backup.tar.gz -C /

# 恢复配置文件
tar -xzf configs_backup.tar.gz -C /

# 重启相关服务
systemctl restart sihui-backend nginx
```

#### 完整系统恢复
```bash
# 1. 恢复数据库
mysql -u sihui_user -p sihui_production < database_backup.sql

# 2. 恢复应用程序
tar -xzf applications_backup.tar.gz -C /opt/sihui/

# 3. 恢复配置文件
tar -xzf configs_backup.tar.gz -C /

# 4. 恢复上传文件
tar -xzf uploads_backup.tar.gz -C /

# 5. 重启所有服务
systemctl restart mysql nginx sihui-backend sihui-frontend

# 6. 验证系统功能
./自动化脚本/监控脚本.sh
```

## 📈 性能优化

### 数据库优化

#### MySQL配置优化
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
query_cache_size = 128M
query_cache_type = 1
max_connections = 200
thread_cache_size = 16
```

#### 查询优化
```bash
# 查看慢查询
mysql -e "SHOW VARIABLES LIKE 'slow_query_log';"

# 分析慢查询
mysqldumpslow /var/log/mysql/mysql-slow.log

# 查看查询缓存状态
mysql -e "SHOW STATUS LIKE 'Qcache%';"
```

### 应用优化

#### JVM参数优化
```bash
# 修改启动参数
vi /etc/systemd/system/sihui-backend.service

# 添加JVM参数
ExecStart=/usr/bin/java -Xms2g -Xmx4g -XX:+UseG1GC -jar /opt/sihui/backend/app.jar
```

#### 缓存优化
```bash
# Redis配置检查
redis-cli INFO memory

# 缓存命中率
redis-cli INFO stats | grep hit
```

### 网络优化

#### Nginx优化
```nginx
# worker进程数
worker_processes auto;

# 连接数优化
worker_connections 4096;

# 缓存优化
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m;

# Gzip压缩
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;
```

## 🔒 安全管理

### 访问控制

#### 系统用户管理
```bash
# 创建运维用户
useradd -m -s /bin/bash sihui-ops
usermod -aG sudo sihui-ops

# SSH密钥配置
mkdir -p /home/sihui-ops/.ssh
cp authorized_keys /home/sihui-ops/.ssh/
chmod 600 /home/sihui-ops/.ssh/authorized_keys
```

#### 防火墙配置
```bash
# Ubuntu UFW
ufw status
ufw allow from 192.168.1.0/24 to any port 22

# CentOS Firewalld
firewall-cmd --list-all
firewall-cmd --add-rich-rule="rule family='ipv4' source address='192.168.1.0/24' port protocol='tcp' port='22' accept"
```

### 安全监控

#### 日志监控
```bash
# 监控登录失败
tail -f /var/log/auth.log | grep "Failed password"

# 监控系统调用
ausearch -ts recent -m LOGIN
```

#### 安全扫描
```bash
# 端口扫描检测
nmap -sS localhost

# 文件完整性检查
aide --check
```

## 📞 故障联系流程

### 联系方式
- **一级支持**: [运维团队联系方式]
- **二级支持**: [开发团队联系方式]
- **紧急联系**: [24小时值班电话]

### 升级流程
1. **L1运维**: 基础故障处理（0-30分钟）
2. **L2开发**: 复杂问题解决（30分钟-2小时）
3. **L3专家**: 架构级问题（2小时以上）

### 报告模板
```
故障报告

时间: [故障发生时间]
影响: [影响范围和用户数]
症状: [具体表现]
原因: [根本原因分析]
解决: [采取的解决措施]
预防: [后续预防措施]
```

## 📋 运维检查清单

### 每日检查
- [ ] 系统资源使用率
- [ ] 服务运行状态
- [ ] 错误日志检查
- [ ] 备份任务执行状态
- [ ] 关键业务指标

### 每周检查
- [ ] 系统安全补丁
- [ ] 性能趋势分析
- [ ] 容量使用评估
- [ ] 备份恢复测试
- [ ] 监控告警规则

### 每月检查
- [ ] 安全漏洞扫描
- [ ] 配置文件审计
- [ ] 用户权限检查
- [ ] 文档更新维护
- [ ] 灾难恢复计划测试

---

**💡 提示**: 保持运维文档的及时更新，记录所有重要的配置变更和故障处理过程，为团队积累宝贵的运维经验。