# 📖 Sihui 智慧学习平台部署指南

## 🎯 部署概述

本指南将帮助您在生产服务器上成功部署 Sihui 智慧学习平台。系统支持两种部署方式：

1. **自动化部署**（推荐）- 一键执行脚本完成所有配置
2. **手动部署** - 逐步执行每个配置步骤

## 🛠️ 环境准备

### 服务器基本要求
- **操作系统**: Ubuntu 20.04 LTS 或 CentOS 8+
- **CPU**: 2核心以上（推荐4核心）
- **内存**: 4GB以上（推荐8GB）
- **存储**: 50GB以上 SSD（推荐100GB）
- **网络**: 外网IP地址，带宽5Mbps以上

### 网络端口要求
- **22**: SSH管理端口
- **80**: HTTP访问端口（重定向到HTTPS）
- **443**: HTTPS访问端口
- **8080**: 后端API服务端口（内部）
- **3000**: 前端服务端口（内部）
- **3306**: MySQL数据库端口（内部）

### 第三方服务要求
- **域名**: 用于系统访问（必需）
- **SSL证书**: HTTPS安全访问（必需）
- **对象存储**: 阿里云OSS/腾讯云COS/七牛云（必需）
- **AI服务**: DeepSeek API Key（必需）
- **微信小程序**: AppId和AppSecret（必需）

## 🚀 自动化部署（推荐）

### 步骤1：准备配置文件

1. **编辑后端配置**
   ```bash
   # 打开配置文件
   vi 部署配置/backend/.env
   ```
   
   **必填项目**：
   ```bash
   # 数据库密码（16位以上强密码）
   DB_PASSWORD=Aa123456!@#$Bb78
   
   # JWT密钥（64位以上随机字符串）
   JWT_SECRET=abcd1234efgh5678ijkl9012mnop3456qrst7890uvwx1234yzab5678cdef9012
   
   # 阿里云OSS配置
   OSS_ACCESS_KEY_ID=LTAI5txxxxxxx
   OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxx
   OSS_BUCKET_NAME=sihui-files
   OSS_DOMAIN=https://sihui-files.oss-cn-hangzhou.aliyuncs.com
   
   # DeepSeek AI Key
   DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx
   
   # 微信小程序配置
   WECHAT_APP_ID=wxxxxxxxxxxxxxxxxx
   WECHAT_APP_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

2. **编辑前端配置**
   ```bash
   # 打开配置文件
   vi 部署配置/frontend/.env.production
   ```
   
   **修改域名**：
   ```bash
   # 将下面的域名改为您的实际域名
   NEXT_PUBLIC_API_URL=https://api.您的域名.com
   NEXT_PUBLIC_WS_URL=wss://api.您的域名.com/ws
   ```

3. **编辑Nginx配置**
   ```bash
   # 打开配置文件
   vi 部署配置/nginx/sihui.conf
   
   # 全局替换域名（vim命令）
   :%s/您的域名.com/example.com/g
   ```

4. **放置SSL证书**
   ```bash
   # 将您的SSL证书文件放到ssl目录
   cp your-domain.com.crt 部署配置/ssl/
   cp your-domain.com.key 部署配置/ssl/
   ```

### 步骤2：上传到服务器

```bash
# 压缩交付包
tar -czf sihui-deployment.tar.gz 客户交付包/

# 上传到服务器
scp sihui-deployment.tar.gz root@your-server-ip:/root/

# 或使用 rsync（推荐）
rsync -avz 客户交付包/ root@your-server-ip:/root/sihui-deployment/
```

### 步骤3：执行自动部署

```bash
# SSH连接到服务器
ssh root@your-server-ip

# 解压部署包
cd /root
tar -xzf sihui-deployment.tar.gz
cd 客户交付包/

# 执行自动部署脚本
chmod +x 自动化脚本/部署安装脚本.sh
./自动化脚本/部署安装脚本.sh
```

### 步骤4：验证部署

部署完成后，脚本会自动进行验证。您也可以手动检查：

```bash
# 检查服务状态
systemctl status sihui-backend sihui-frontend nginx mysql

# 检查端口监听
ss -tlnp | grep -E ':80|:443|:8080|:3000'

# 测试API健康状态
curl https://api.your-domain.com/health

# 查看实时日志
journalctl -u sihui-backend -f
```

## 🔧 手动部署

如果您选择手动部署，请按以下步骤操作：

### 1. 更新系统

**Ubuntu/Debian:**
```bash
apt update && apt upgrade -y
```

**CentOS/RHEL:**
```bash
yum update -y
```

### 2. 安装基础软件

**Ubuntu/Debian:**
```bash
# 安装基础包
apt install -y curl wget git unzip nginx mysql-server

# 安装 Java 8
apt install -y openjdk-8-jdk maven

# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs
```

**CentOS/RHEL:**
```bash
# 安装基础包
yum install -y curl wget git unzip nginx mysql-server

# 安装 Java 8
yum install -y java-1.8.0-openjdk maven

# 安装 Node.js 18
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs
```

### 3. 创建目录结构

```bash
mkdir -p /opt/sihui/{backend,frontend,nginx,ssl,logs,uploads,backup}
chown -R www-data:www-data /opt/sihui  # Ubuntu
# 或
chown -R nginx:nginx /opt/sihui        # CentOS
```

### 4. 配置MySQL

```bash
# 启动MySQL
systemctl start mysql
systemctl enable mysql

# 登录MySQL（首次无密码）
mysql -u root

# 在MySQL中执行
CREATE DATABASE sihui_production;
CREATE USER 'sihui_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON sihui_production.* TO 'sihui_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 5. 部署后端

```bash
# 复制项目文件
cp -r 项目源码/sihui-backend/* /opt/sihui/backend/
cp 部署配置/backend/.env /opt/sihui/backend/

# 构建项目
cd /opt/sihui/backend
mvn clean package -DskipTests

# 复制jar文件
cp target/sihui-backend-*.jar /opt/sihui/backend/app.jar
```

### 6. 部署前端

```bash
# 复制项目文件
cp -r 项目源码/admin-dashboard_3/* /opt/sihui/frontend/
cp 部署配置/frontend/.env.production /opt/sihui/frontend/

# 安装依赖并构建
cd /opt/sihui/frontend
npm ci --production
npm run build
```

### 7. 配置Nginx

```bash
# 复制配置文件
cp 部署配置/nginx/sihui.conf /etc/nginx/sites-available/  # Ubuntu
# 或
cp 部署配置/nginx/sihui.conf /etc/nginx/conf.d/          # CentOS

# 启用站点（Ubuntu）
ln -sf /etc/nginx/sites-available/sihui.conf /etc/nginx/sites-enabled/

# 复制SSL证书
cp 部署配置/ssl/* /opt/sihui/ssl/
chmod 600 /opt/sihui/ssl/*

# 测试配置
nginx -t
```

### 8. 创建系统服务

**后端服务:**
```bash
cat > /etc/systemd/system/sihui-backend.service <<EOF
[Unit]
Description=Sihui Backend Service
After=mysql.service

[Service]
Type=simple
User=www-data
ExecStart=/usr/bin/java -jar /opt/sihui/backend/app.jar
WorkingDirectory=/opt/sihui/backend
Restart=always
RestartSec=10
Environment=SPRING_PROFILES_ACTIVE=production

[Install]
WantedBy=multi-user.target
EOF
```

**前端服务:**
```bash
cat > /etc/systemd/system/sihui-frontend.service <<EOF
[Unit]
Description=Sihui Frontend Service
After=network.target

[Service]
Type=simple
User=www-data
ExecStart=/usr/bin/npm start
WorkingDirectory=/opt/sihui/frontend
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF
```

### 9. 启动服务

```bash
# 重载systemd配置
systemctl daemon-reload

# 启动并设置开机自启
systemctl enable --now mysql nginx sihui-backend sihui-frontend

# 检查状态
systemctl status sihui-backend sihui-frontend nginx
```

### 10. 配置防火墙

**Ubuntu (UFW):**
```bash
ufw enable
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
```

**CentOS (Firewalld):**
```bash
systemctl enable --now firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

## 🔍 部署验证

### 1. 服务检查

```bash
# 检查所有服务状态
systemctl status sihui-backend sihui-frontend nginx mysql

# 检查端口监听
ss -tlnp | grep -E ':80|:443|:8080|:3000|:3306'

# 检查磁盘空间
df -h

# 检查内存使用
free -h
```

### 2. 功能测试

1. **后端API测试**
   ```bash
   # 健康检查
   curl https://api.your-domain.com/health
   
   # Swagger文档
   curl https://api.your-domain.com/swagger-ui.html
   ```

2. **前端访问测试**
   - 浏览器访问：`https://admin.your-domain.com`
   - 检查登录页面是否正常显示
   - 测试用户登录功能

3. **数据库连接测试**
   ```bash
   # 连接数据库
   mysql -u sihui_user -p sihui_production
   
   # 查看表结构
   SHOW TABLES;
   ```

### 3. 性能测试

```bash
# CPU使用率
top

# 内存使用
free -h

# 磁盘I/O
iotop

# 网络连接
netstat -tlnp
```

## 🚨 故障排除

### 常见问题

**1. 服务启动失败**
```bash
# 查看详细错误日志
journalctl -u sihui-backend -l
journalctl -u sihui-frontend -l

# 检查配置文件
cat /opt/sihui/backend/.env
cat /opt/sihui/frontend/.env.production
```

**2. 数据库连接失败**
```bash
# 检查MySQL状态
systemctl status mysql

# 测试数据库连接
mysql -u sihui_user -p -h localhost

# 检查数据库配置
grep DB_ /opt/sihui/backend/.env
```

**3. Nginx配置错误**
```bash
# 测试配置文件语法
nginx -t

# 查看错误日志
tail -f /var/log/nginx/error.log

# 检查端口占用
ss -tlnp | grep :80
```

**4. SSL证书问题**
```bash
# 检查证书文件
ls -la /opt/sihui/ssl/

# 测试证书
openssl x509 -in /opt/sihui/ssl/your-domain.com.crt -text -noout

# 检查证书有效期
openssl x509 -in /opt/sihui/ssl/your-domain.com.crt -noout -dates
```

### 日志位置

- **Nginx日志**: `/var/log/nginx/`
- **后端日志**: `journalctl -u sihui-backend`
- **前端日志**: `journalctl -u sihui-frontend`
- **MySQL日志**: `/var/log/mysql/`
- **系统日志**: `/var/log/syslog`

## 🔄 更新升级

### 应用更新

```bash
# 停止服务
systemctl stop sihui-backend sihui-frontend

# 备份当前版本
cp /opt/sihui/backend/app.jar /opt/sihui/backup/app.jar.backup

# 部署新版本
cp new-version/app.jar /opt/sihui/backend/

# 重启服务
systemctl start sihui-backend sihui-frontend
```

### 数据库迁移

```bash
# 备份数据库
mysqldump -u sihui_user -p sihui_production > backup.sql

# 执行迁移脚本
mysql -u sihui_user -p sihui_production < migration.sql
```

## 🏁 部署完成

恭喜！您已成功部署 Sihui 智慧学习平台。

**访问地址：**
- 管理后台：`https://admin.your-domain.com`
- API服务：`https://api.your-domain.com`
- API文档：`https://api.your-domain.com/swagger-ui.html`

**下一步：**
1. 登录管理后台创建管理员账户
2. 配置系统基本信息
3. 测试所有功能模块
4. 配置数据备份策略
5. 设置监控告警

如有任何问题，请参考故障排除章节或联系技术支持。