# 📝 Sihui 项目本地配置指南

## 🎯 目标
在本地填写好所有配置信息，打包后上传到服务器，服务器端只需要运行一个脚本即可完成部署。

## 📋 配置前准备清单

### 必需信息
- [ ] **域名**: 您的域名 (如: example.com)
- [ ] **SSL证书**: .crt 和 .key 文件
- [ ] **数据库密码**: 强密码 (建议12位以上)
- [ ] **JWT密钥**: 64位以上随机字符串
- [ ] **对象存储配置**: 阿里云OSS/腾讯云COS/七牛云
- [ ] **DeepSeek API Key**: AI服务密钥
- [ ] **微信小程序**: AppId 和 AppSecret

### 可选信息
- [ ] **邮件服务**: SMTP配置
- [ ] **Redis配置**: 如需缓存
- [ ] **监控服务**: Sentry DSN等

---

## 🔧 详细配置步骤

### 1. 编辑后端环境变量

打开 `backend/.env` 文件，按以下模板填写：

```bash
# ===========================================
# 必填项目
# ===========================================

# 数据库密码 (必填)
DB_PASSWORD=您的强密码123!@#

# JWT安全密钥 (必填，64位以上)
JWT_SECRET=your_very_long_and_secure_jwt_secret_key_here_64_characters_minimum

# 对象存储配置 (三选一，必填)
# 选择阿里云OSS
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
OSS_ACCESS_KEY_ID=您的AccessKeyId
OSS_ACCESS_KEY_SECRET=您的AccessKeySecret
OSS_BUCKET_NAME=您的Bucket名称
OSS_DOMAIN=https://您的Bucket.oss-cn-hangzhou.aliyuncs.com

# AI服务配置 (必填)
DEEPSEEK_API_KEY=您的DeepSeek API Key

# 微信小程序配置 (必填)
WECHAT_APP_ID=您的微信小程序AppId
WECHAT_APP_SECRET=您的微信小程序AppSecret

# ===========================================
# 可选项目 (根据需要填写)
# ===========================================

# 邮件服务 (可选)
MAIL_HOST=smtp.qq.com
MAIL_PORT=587
MAIL_USERNAME=your-email@qq.com
MAIL_PASSWORD=您的邮箱授权码
MAIL_FROM=your-email@qq.com

# Redis缓存 (可选)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=您的Redis密码
REDIS_DATABASE=0
```

### 2. 编辑前端环境变量

打开 `frontend/.env.production` 文件，修改域名：

```bash
# API配置 (修改为您的实际域名)
NEXT_PUBLIC_API_URL=https://api.您的域名.com
NEXT_PUBLIC_WS_URL=wss://api.您的域名.com/ws

# 文件上传配置 (修改为您的实际域名)
NEXT_PUBLIC_UPLOAD_URL=https://api.您的域名.com/api/files/upload

# 其他配置一般无需修改
NEXT_PUBLIC_APP_NAME=Sihui管理系统
NEXT_PUBLIC_APP_VERSION=1.0.0
NEXT_PUBLIC_ENABLE_CHAT=true
NEXT_PUBLIC_ENABLE_VIDEO_PREVIEW=true
```

### 3. 编辑Nginx配置

打开 `nginx/sihui.conf` 文件，修改域名：

```nginx
# 将所有 "您的实际域名.com" 替换为您的真实域名
# 例如：your-domain.com

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name api.your-domain.com admin.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# 后端API服务
server {
    listen 443 ssl http2;
    server_name api.your-domain.com;
    
    # SSL证书配置 (修改证书文件名)
    ssl_certificate /opt/sihui/ssl/your-domain.com.crt;
    ssl_certificate_key /opt/sihui/ssl/your-domain.com.key;
    
    # ... 其他配置保持不变
}

# 管理端前端服务  
server {
    listen 443 ssl http2;
    server_name admin.your-domain.com;
    
    # SSL证书配置 (修改证书文件名)
    ssl_certificate /opt/sihui/ssl/your-domain.com.crt;
    ssl_certificate_key /opt/sihui/ssl/your-domain.com.key;
    
    # ... 其他配置保持不变
}
```

### 4. 准备SSL证书

将您的SSL证书文件放入 `ssl/` 目录：

```
ssl/
├── your-domain.com.crt    # 证书文件
├── your-domain.com.key    # 私钥文件
└── ca-bundle.crt          # 证书链 (如有)
```

**证书文件命名要求**：
- 文件名必须与Nginx配置中的一致
- 建议使用域名作为文件名前缀

### 5. 准备项目源码

将整个Sihui项目源码复制到部署包中：

```
完整部署包/
├── Sihui/                 # 项目源码目录
│   ├── sihui-backend/     # 后端项目
│   ├── admin-dashboard_3/ # 前端项目
│   └── sihui-wx/         # 微信小程序 (不需要部署)
├── backend/
├── frontend/
├── nginx/
├── ssl/
├── systemd/
└── server-install.sh
```

---

## 🎛️ 不同云服务商配置示例

### 阿里云OSS配置
```bash
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
OSS_ACCESS_KEY_ID=LTAI5t...
OSS_ACCESS_KEY_SECRET=xxx...
OSS_BUCKET_NAME=sihui-files
OSS_DOMAIN=https://sihui-files.oss-cn-hangzhou.aliyuncs.com
```

### 腾讯云COS配置
```bash
# 注释掉OSS相关配置，启用COS配置
COS_REGION=ap-guangzhou
COS_SECRET_ID=AKIDxxx...
COS_SECRET_KEY=xxx...
COS_BUCKET_NAME=sihui-files-1234567890
COS_DOMAIN=https://sihui-files-1234567890.cos.ap-guangzhou.myqcloud.com
```

### 七牛云配置
```bash
# 注释掉OSS相关配置，启用七牛云配置
QINIU_ACCESS_KEY=xxx...
QINIU_SECRET_KEY=xxx...
QINIU_BUCKET_NAME=sihui-files
QINIU_DOMAIN=https://cdn.your-domain.com
```

---

## 🔐 安全配置建议

### 1. 强密码生成
```bash
# 数据库密码示例 (16位)
DB_PASSWORD=Aa123456!@#$Bb78

# JWT密钥示例 (64位)
JWT_SECRET=abcd1234efgh5678ijkl9012mnop3456qrst7890uvwx1234yzab5678cdef9012
```

### 2. 密钥生成工具
```powershell
# Windows PowerShell 生成随机密钥
# 生成16位数据库密码
[System.Web.Security.Membership]::GeneratePassword(16, 4)

# 生成64位JWT密钥
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | % {[char]$_})
```

### 3. 在线生成工具
- **密码生成**: https://passwordsgenerator.net/
- **JWT密钥**: https://jwt.io/ 或 https://randomkeygen.com/

---

## 📦 打包和上传

### 1. 检查配置完整性
确保以下文件都已正确配置：
- [ ] `backend/.env` - 所有"请填写..."都已替换
- [ ] `frontend/.env.production` - 域名已修改
- [ ] `nginx/sihui.conf` - 域名已修改
- [ ] `ssl/` - 证书文件已放置
- [ ] `Sihui/` - 项目源码已复制

### 2. 压缩部署包
```powershell
# 使用PowerShell压缩
Compress-Archive -Path ".\完整部署包\*" -DestinationPath ".\sihui-deployment.zip"
```

### 3. 上传到服务器
使用XFTP、SCP或其他工具上传：
```bash
# 使用scp上传 (示例)
scp sihui-deployment.zip root@your-server-ip:/root/

# 在服务器上解压
unzip sihui-deployment.zip
```

---

## 🚀 服务器端部署

### 1. 连接服务器
```bash
ssh root@your-server-ip
```

### 2. 解压并执行安装
```bash
# 解压部署包
unzip sihui-deployment.zip
cd 完整部署包/

# 添加执行权限并运行
chmod +x server-install.sh
sudo bash server-install.sh
```

### 3. 可选：从Git仓库安装
```bash
# 如果项目在Git仓库中
sudo bash server-install.sh https://github.com/your-username/Sihui.git
```

---

## ✅ 验证部署

安装完成后，检查以下内容：

### 1. 服务状态
```bash
systemctl status sihui-backend sihui-frontend nginx mysql
```

### 2. 端口监听
```bash
netstat -tlnp | grep -E ':80|:443|:8080|:3000'
```

### 3. 访问测试
- 🌐 管理端: https://admin.your-domain.com
- 🔗 API健康检查: https://api.your-domain.com/health
- 📚 API文档: https://api.your-domain.com/swagger-ui.html

### 4. 日志检查
```bash
# 后端日志
journalctl -u sihui-backend -f

# 前端日志  
journalctl -u sihui-frontend -f

# Nginx日志
tail -f /var/log/nginx/access.log
```

---

## 🆘 常见问题解决

### 1. 数据库连接失败
- 检查 `backend/.env` 中的数据库密码
- 确认MySQL服务已启动: `systemctl status mysql`

### 2. 域名无法访问
- 检查域名DNS解析是否正确
- 确认防火墙已开放80、443端口

### 3. SSL证书错误
- 检查证书文件路径和权限
- 验证证书是否匹配域名

### 4. 服务启动失败
- 查看详细日志: `journalctl -u service-name -l`
- 检查配置文件语法: `nginx -t`

---

## 📞 技术支持

如遇到问题，请提供以下信息：
1. 错误日志内容
2. 服务器系统版本
3. 配置文件内容 (隐去敏感信息)
4. 域名和SSL证书类型

**🎉 配置完成后，您的Sihui系统就可以投入使用了！** 