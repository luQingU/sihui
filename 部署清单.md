# 🚀 Sihui项目服务器部署清单

## 📋 部署概览

**需要部署的组件：**
- ✅ 后端服务 (Java 8 + Spring Boot + MySQL 8)
- ✅ 管理端 (Next.js)
- ❌ 微信小程序 (发布到微信小程序官网，无需服务器部署)

## 🖥️ 服务器环境要求

### 基础环境
- [ ] **操作系统**: Linux (推荐 Ubuntu 20.04 LTS 或 CentOS 8+)
- [ ] **CPU**: 2核心以上
- [ ] **内存**: 4GB以上 (推荐8GB)
- [ ] **硬盘**: 50GB以上 SSD
- [ ] **网络**: 外网IP，开放端口 80, 443, 22

### 软件环境
- [ ] **Java**: OpenJDK 8 或 Oracle JDK 8
- [ ] **Maven**: 3.6+
- [ ] **MySQL**: 8.0+
- [ ] **Node.js**: 18.x LTS
- [ ] **Nginx**: 1.18+
- [ ] **Docker** (可选): 最新版本
- [ ] **Git**: 最新版本

## 🌐 域名与SSL证书

### 域名配置
- [ ] **主域名**: `your-domain.com`
- [ ] **后端API域名**: `api.your-domain.com`
- [ ] **管理端域名**: `admin.your-domain.com`
- [ ] **域名DNS解析**: 已解析到服务器IP

### SSL证书
- [ ] **证书类型**: 
  - [ ] 免费证书 (Let's Encrypt)
  - [ ] 付费证书 (阿里云/腾讯云)
- [ ] **证书文件**: 
  - [ ] `your-domain.com.crt` (证书文件)
  - [ ] `your-domain.com.key` (私钥文件)
  - [ ] `ca-bundle.crt` (证书链文件，如有)

## 🗄️ 数据库配置

### MySQL配置信息
```bash
# 数据库连接信息
DB_HOST=localhost
DB_PORT=3306
DB_NAME=sihui_production
DB_USERNAME=sihui_user
DB_PASSWORD=your_secure_password

# 数据库root密码
MYSQL_ROOT_PASSWORD=your_root_password
```

### 数据库准备
- [ ] **创建数据库**: `sihui_production`
- [ ] **创建用户**: `sihui_user`
- [ ] **授权**: 给用户完整权限
- [ ] **执行迁移脚本**: 运行 `/sihui-backend/src/main/resources/db/migration/` 下的SQL文件

## ☁️ 对象存储配置

### 阿里云OSS (推荐)
```bash
# OSS配置
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET_NAME=sihui-files
OSS_DOMAIN=https://your-bucket.oss-cn-hangzhou.aliyuncs.com
```

### 腾讯云COS (备选)
```bash
# COS配置
COS_REGION=ap-guangzhou
COS_SECRET_ID=your_secret_id
COS_SECRET_KEY=your_secret_key
COS_BUCKET_NAME=sihui-files-1234567890
COS_DOMAIN=https://your-bucket.cos.ap-guangzhou.myqcloud.com
```

### 七牛云 (备选)
```bash
# 七牛云配置
QINIU_ACCESS_KEY=your_access_key
QINIU_SECRET_KEY=your_secret_key
QINIU_BUCKET_NAME=sihui-files
QINIU_DOMAIN=https://your-domain.qiniucdn.com
```

## 🤖 AI服务配置

### DeepSeek配置
```bash
# DeepSeek API配置
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_BASE_URL=https://api.deepseek.com
```

### 其他AI服务 (可选)
```bash
# OpenAI (如需要)
OPENAI_API_KEY=your_openai_api_key

# 百度文心 (如需要)
BAIDU_API_KEY=your_baidu_api_key
BAIDU_SECRET_KEY=your_baidu_secret_key
```

## 🔧 环境变量配置

### 后端环境变量 (.env)
```bash
# 应用配置
SPRING_PROFILES_ACTIVE=production
SERVER_PORT=8080

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=sihui_production
DB_USERNAME=sihui_user
DB_PASSWORD=your_secure_password

# JWT配置
JWT_SECRET=your_very_long_and_secure_jwt_secret_key_here
JWT_EXPIRATION=604800000

# 文件上传配置
FILE_UPLOAD_PATH=/opt/sihui/uploads
FILE_MAX_SIZE=10MB

# 对象存储配置 (选择其一)
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET_NAME=sihui-files

# AI服务配置
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_BASE_URL=https://api.deepseek.com

# Redis配置 (如使用)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# 邮件配置 (如需要)
MAIL_HOST=smtp.your-domain.com
MAIL_PORT=587
MAIL_USERNAME=noreply@your-domain.com
MAIL_PASSWORD=your_mail_password
```

### 前端环境变量 (.env.production)
```bash
# API配置
NEXT_PUBLIC_API_URL=https://api.your-domain.com
NEXT_PUBLIC_WS_URL=wss://api.your-domain.com/ws

# 应用配置
NEXT_PUBLIC_APP_NAME=Sihui管理系统
NEXT_PUBLIC_APP_VERSION=1.0.0

# 文件上传配置
NEXT_PUBLIC_MAX_FILE_SIZE=10485760
NEXT_PUBLIC_ALLOWED_FILE_TYPES=.jpg,.jpeg,.png,.pdf,.doc,.docx

# 其他配置
NEXT_PUBLIC_ENABLE_ANALYTICS=true
```

## 📁 部署目录结构

```
/opt/sihui/
├── backend/                 # 后端项目目录
├── frontend/               # 前端项目目录
├── nginx/                  # Nginx配置
├── ssl/                    # SSL证书目录
├── logs/                   # 日志目录
├── uploads/                # 文件上传目录
└── backup/                 # 备份目录
```

## 🚀 部署步骤

### 1. 服务器初始化
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 创建部署目录
sudo mkdir -p /opt/sihui/{backend,frontend,nginx,ssl,logs,uploads,backup}
sudo chown -R $USER:$USER /opt/sihui
```

### 2. 安装基础软件
```bash
# 安装Java 8
sudo apt install openjdk-8-jdk -y

# 安装Maven
sudo apt install maven -y

# 安装MySQL
sudo apt install mysql-server -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs -y

# 安装Nginx
sudo apt install nginx -y

# 安装Git
sudo apt install git -y
```

### 3. 克隆项目
```bash
cd /opt/sihui
git clone https://github.com/your-username/Sihui.git
# 或者使用XFTP上传项目文件
```

### 4. 配置环境变量
```bash
# 后端环境变量
cd /opt/sihui/Sihui/sihui-backend
cp .env.example .env
# 编辑 .env 文件，填入上述配置信息

# 前端环境变量
cd /opt/sihui/Sihui/admin-dashboard_3
cp .env.example .env.production
# 编辑 .env.production 文件，填入上述配置信息
```

### 5. 数据库初始化
```bash
# 登录MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE sihui_production;
CREATE USER 'sihui_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON sihui_production.* TO 'sihui_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 执行数据库迁移
cd /opt/sihui/Sihui/sihui-backend
mysql -u sihui_user -p sihui_production < src/main/resources/db/migration/V1__Create_core_tables.sql
mysql -u sihui_user -p sihui_production < src/main/resources/db/migration/V2__Insert_initial_data.sql
mysql -u sihui_user -p sihui_production < src/main/resources/db/migration/V3__Create_chat_tables.sql
```

### 6. 构建和部署后端
```bash
cd /opt/sihui/Sihui/sihui-backend
mvn clean package -DskipTests
sudo cp target/sihui-backend-*.jar /opt/sihui/backend/app.jar
```

### 7. 构建和部署前端
```bash
cd /opt/sihui/Sihui/admin-dashboard_3
npm install
npm run build
sudo cp -r .next /opt/sihui/frontend/
sudo cp -r public /opt/sihui/frontend/
sudo cp package.json /opt/sihui/frontend/
sudo cp next.config.mjs /opt/sihui/frontend/
```

### 8. 配置Nginx
```bash
# 复制Nginx配置
sudo cp /opt/sihui/Sihui/config/nginx/nginx.conf /etc/nginx/
sudo cp /opt/sihui/Sihui/config/nginx/conf.d/* /etc/nginx/conf.d/

# 修改配置文件中的域名和路径
sudo nano /etc/nginx/conf.d/default.conf
```

### 9. 配置SSL证书
```bash
# 将SSL证书复制到指定目录
sudo cp your-domain.com.crt /opt/sihui/ssl/
sudo cp your-domain.com.key /opt/sihui/ssl/
sudo chmod 600 /opt/sihui/ssl/*
```

### 10. 创建系统服务
```bash
# 后端服务
sudo tee /etc/systemd/system/sihui-backend.service > /dev/null <<EOF
[Unit]
Description=Sihui Backend Service
After=mysql.service

[Service]
Type=simple
User=www-data
ExecStart=/usr/bin/java -jar /opt/sihui/backend/app.jar
Restart=always
RestartSec=10
Environment=SPRING_PROFILES_ACTIVE=production

[Install]
WantedBy=multi-user.target
EOF

# 前端服务
sudo tee /etc/systemd/system/sihui-frontend.service > /dev/null <<EOF
[Unit]
Description=Sihui Frontend Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/sihui/frontend
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

### 11. 启动服务
```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启动并设置开机自启
sudo systemctl enable mysql nginx sihui-backend sihui-frontend
sudo systemctl start mysql nginx sihui-backend sihui-frontend

# 检查服务状态
sudo systemctl status sihui-backend sihui-frontend nginx
```

## 🔍 部署验证

### 检查服务状态
```bash
# 检查端口监听
sudo netstat -tlnp | grep -E ':80|:443|:8080|:3000'

# 检查日志
sudo journalctl -u sihui-backend -f
sudo journalctl -u sihui-frontend -f

# 检查Nginx状态
sudo nginx -t
```

### 访问测试
- [ ] **后端API**: `https://api.your-domain.com/health`
- [ ] **管理端**: `https://admin.your-domain.com`
- [ ] **SSL证书**: 检查浏览器是否显示安全锁

## 🛡️ 安全配置

### 防火墙配置
```bash
# 启用UFW防火墙
sudo ufw enable

# 开放必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS

# 查看防火墙状态
sudo ufw status
```

### 其他安全措施
- [ ] **修改SSH端口** (非22)
- [ ] **禁用root用户SSH登录**
- [ ] **配置fail2ban** 防止暴力破解
- [ ] **定期备份数据库**
- [ ] **设置logrotate** 日志轮转

## 📝 监控与维护

### 日志位置
- **Nginx日志**: `/var/log/nginx/`
- **后端日志**: `/opt/sihui/logs/`
- **前端日志**: `sudo journalctl -u sihui-frontend`
- **系统日志**: `/var/log/syslog`

### 备份脚本
```bash
# 创建备份脚本
sudo tee /opt/sihui/backup/backup.sh > /dev/null <<'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u sihui_user -p sihui_production > /opt/sihui/backup/database_$DATE.sql
tar -czf /opt/sihui/backup/uploads_$DATE.tar.gz /opt/sihui/uploads/
EOF

sudo chmod +x /opt/sihui/backup/backup.sh
```

## 📞 联系信息

### 开发团队
- **后端开发**: [您的联系方式]
- **前端开发**: [您的联系方式]
- **运维支持**: [您的联系方式]

### 紧急联系
- **服务器问题**: [联系方式]
- **域名问题**: [域名服务商]
- **SSL证书问题**: [证书服务商]

---

## ✅ 部署完成检查清单

完成以下所有项目后，您的项目就成功部署了：

- [ ] 服务器环境准备完成
- [ ] 域名解析配置完成
- [ ] SSL证书安装完成
- [ ] 数据库初始化完成
- [ ] 后端服务部署完成
- [ ] 前端服务部署完成
- [ ] Nginx配置完成
- [ ] 防火墙配置完成
- [ ] 服务自启动配置完成
- [ ] 备份策略配置完成
- [ ] 监控告警配置完成
- [ ] 访问测试通过

**🎉 恭喜！您的Sihui项目已成功部署到生产服务器！** 